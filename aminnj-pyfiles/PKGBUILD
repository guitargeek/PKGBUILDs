# Maintainer: Jonas Rembser <jonas.rembser@gmail.com>

pkgname=aminnj-pyfiles
pkgver=0.0.1
pkgrel=1
arch=("i686" "x86_64")
url="https://github.com/Amarang/syncfiles"
makedepends=("git")
provides=("aminnj-pyfiles")
source=("git+https://github.com/Amarang/syncfiles#branch=master"
        "commands_fix.patch"
        "str_encode_fix.patch")
sha512sums=('SKIP'
            '1f4b225bd0537c9b719c35e5a691810aa911f9ff046158b27f45a86bc0a135cf565bcd8e70c695a678e89f1c65b2df8dc04160449b722434183bf827567af2ee'
            'a2ff34810a4a1598418e508bbea00c91ffe87a5e467b7e6c908df32c40273e3e859b7da7e16e8360360f3605876e7cd3922c6f080a36b983847684586447f63f')

build() {
    patch -u  syncfiles/pyfiles/tabletex.py commands_fix.patch
    patch -u  syncfiles/pyfiles/pytable.py str_encode_fix.patch

    cd syncfiles/pyfiles

    rm __init__.py
    rm -rf examples

    # Ootherwise the code might yield indentation errors
    autopep8 -i -r .

    # We want to use python3
    python-modernize -w -n . > /dev/null

    # This was done in the original Makefile, so we do it here too
    python -m compileall -q python
}

package() {
    PYTHON_VERSION=$(python -c "import sys; print('{0}.{1}'.format(sys.version_info.major, sys.version_info.minor))")
    PYTHON_SITE_PACKAGES=$pkgdir/usr/lib/python$PYTHON_VERSION/site-packages

    mkdir -p $PYTHON_SITE_PACKAGES

    mv syncfiles/pyfiles/* $PYTHON_SITE_PACKAGES/

    find  $PYTHON_SITE_PACKAGES -type f -exec sed -i -e 's/u"\\u00B1".encode("utf-8")/"Â±"/g' {} \;
}

# Maintainer: Jonas Rembser <jonas.rembser@gmail.com>

pkgname=rooutil
pkgver=0.0.1
pkgrel=1
arch=("i686" "x86_64")
url="https://github.com/sgnoohc/rooutil"
depends=("python" "root" "cmake")
provides=("rooutil")
source=("git+https://github.com/sgnoohc/rooutil#branch=master")
md5sums=('SKIP')

build() {
    echo 'project(rooutil CXX)
cmake_minimum_required(VERSION 3.2)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC -O2")

find_package(ROOT REQUIRED COMPONENTS EG GenVector MLP TreePlayer XMLIO TMVA)
include(${ROOT_USE_FILE})

include_directories(.)

file(GLOB HEADER_FILES rooutil/*.h)

add_library(rooutil SHARED rooutil/rooutil.cc)
set_target_properties(rooutil PROPERTIES PUBLIC_HEADER "${HEADER_FILES}")
target_link_libraries(rooutil PUBLIC ${ROOT_LIBRARIES})

install(TARGETS rooutil
        LIBRARY DESTINATION ${CMAKE_INSTALL_PREFIX}/lib
        PUBLIC_HEADER DESTINATION ${CMAKE_INSTALL_PREFIX}/include
)' > CMakeLists.txt

    find rooutil -type f -exec sed -i -e 's/cxxopts\.h/cxxopts\.hpp/g' {} \;
    find rooutil/.git -type f -exec sed -i -e 's/cxxopts\.hpp/cxxopts\.h/g' {} \;
    cd rooutil

    rm cxxopts.h cxxopts.cc

    # We want to use python3
    python-modernize -w -n . > /dev/null

    python -m compileall -q python

    cd ..

    mkdir build
    cd build
    cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr ..
    make -j8 || return 1
}

package() {
    cd build
    make DESTDIR="$pkgdir/" install

    cd ../rooutil

    find . -type f -exec sed -i -e 's/u"\\u00B1".encode("utf-8")/"Â±"/g' {} \;
    find . -type f -exec sed -i -e 's/from \.plottery/from plottery/g' {} \;
    find . -type f -exec sed -i -e 's/from . import pyrootutil/import pyrootutil/g' {} \;
    find . -type f -exec sed -i -e 's/from . import plottery_wrapper/import plottery_wrapper/g' {} \;

    mkdir -p $pkgdir/usr/bin
    cp *.sh $pkgdir/usr/bin/

    rm $pkgdir/usr/bin/root.sh
    rm $pkgdir/usr/bin/thisrooutil.sh

    PYTHON_VERSION=$(python -c "import sys; print('{0}.{1}'.format(sys.version_info.major, sys.version_info.minor))")
    PYTHON_SITE_PACKAGES=$pkgdir/usr/lib/python$PYTHON_VERSION/site-packages

    mkdir -p $PYTHON_SITE_PACKAGES
    cp *.py $PYTHON_SITE_PACKAGES/
    cp index.php $PYTHON_SITE_PACKAGES/
    rm $PYTHON_SITE_PACKAGES/__init__.py
    rm $PYTHON_SITE_PACKAGES/yield_for_keynote.py

    cp *.py $pkgdir/usr/bin/
    rm $pkgdir/usr/bin/__init__.py

    tail -n +2  $pkgdir/usr/bin/yield_for_keynote.py > tmp
    mv tmp $pkgdir/usr/bin/yield_for_keynote.py
    chmod +x $pkgdir/usr/bin/yield_for_keynote.py

    wget https://raw.githubusercontent.com/Amarang/syncfiles/master/miscfiles/index.php
    mkdir -p $PYTHON_SITE_PACKAGES/syncfiles/miscfiles
    mv index.php $PYTHON_SITE_PACKAGES/syncfiles/miscfiles/
}

# Maintainer: Jonas Rembser <jonas.rembser gmail com>

pkgname=dd4hep
pkgver=01.12.01
_pkgver=$( echo ${pkgver} | tr '.' '-' ) 
pkgrel=1
arch=("i686" "x86_64")
url="https://github.com/AIDASoft/DD4hep"
provides=("dd4hep")
source=("https://github.com/AIDASoft/DD4hep/archive/v${_pkgver}.tar.gz"
        "DigiKernel.patch")
sha512sums=('cac7d6ea3468e923e8dbe65ac690820d444b022ea15809facfb6407a411192a3a6051ee872f44f0316a32cb6f255e0fdbe68ef47b25c756876a2839b6a860709'
            'af22ff1a9c50a829c1b745e1d16fffe8379d9a54724990f64d1ff08221d7e7a93e1defeee64f4535811f00b3ee228f7255f5e18f6e358fdcb8cbd077a0456e0e')

prepare() {
    patch DD4hep-${_pkgver}/DDDigi/src/DigiKernel.cpp DigiKernel.patch

    # There is something strange with a missing newline, so let's add it
    echo "" > DD4hep-01-12-01/DDParsers/src/Spirit/ParserStandardList_Mapstring_bool.cpp

    mkdir -p build
}

build() {
    cd build

    cmake -E env CXXFLAGS="-fno-var-tracking-assignments" cmake \
          -DCMAKE_INSTALL_PREFIX:PATH=/usr \
          -DDD4HEP_USE_GEANT4=ON \
          -DDD4HEP_IGNORE_GEANT4_TLS=True \
          -DBoost_NO_BOOST_CMAKE=OFF \
          -DDD4HEP_USE_LCIO=OFF \
          -DBUILD_TESTING=ON \
          -DROOT_DIR=$ROOTSYS \
          ../DD4hep-${_pkgver}

    make -j8
}

package() {
    mkdir $pkgdir/usr
    cd build
    make DESTDIR="$pkgdir/" install
}
